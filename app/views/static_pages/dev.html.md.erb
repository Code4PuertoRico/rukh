## Procedure for a tomcat7 deploy on Windows & Ubuntu
### Procedimiento para hacer un tomcat7/Rails4 deploy en windows & ubuntu

## Server:

1. **Download:** [JDK7](http://www.oracle.com/technetwork/java/javase/downloads/index.html) + [tomcat7](http://tomcat.apache.org/download-70.cgi) + [JRuby 1.7.5 or later](http://www.jruby.org/download) + [Mariadb5.5](https://downloads.mariadb.org/) (or MySQL db or other db) & install them (see installation instructions).
  - *(Bajar el Java Development Kit 7 (mas reciente), tomcat 7, JRuby 1.7.5 o mas reciente (1.7.10 es el mas reciente) y Mariadb 5.5 (o MySQL) & instalalos (ver instruciones para instalación). )*
  
2. Set `JRUBY_OPTS --2.0` in the **Environmental Variables**.  ('Control Panel > System > Advanced system settings >> Environmental Variables...').  
  - *(En 'Control Panel > System > Advanced system settings >> Environmental Variables...' cree una nueva variable `JRUBY_OPTS` y en su valor ponga `--2.0`.  Este paso posiblemente no sea necesario con JRuby 9K en adelante.)*  ![Environmental Variables](<%= asset_path('environmental_variables.png') %> "Environmental Variables")
  
  Ubuntu/Mac: put this: `export JRUBY_OPTS=--2.0` in .bashrc/.bash_profile of the deploy user.
  
3. Download and install **Java Cryptographic Extensions (JCE)** security files for Java7 and  on your `jre7/lib/security` folder overwrite the `local_policy.jar` and `US_export_policy.jar`. In windows the JRE is located usually in `Program Files`.![Files to Replace](<%= asset_path('JCE_replace_files.png') %> "JCE replace files")
  - *(Bajar e instalar los JCE (Java Cryptographic Exentsions) del website de Oracle y remplazar los archivos indicados.)*  
  Ubuntu: if `which javac` is '/usr/bin/javac' then`echo $(readlink -f /usr/bin/javac | sed "s:bin/javac::")` produces the Java Home path.Switch to that directory and then drill into `jre/lib/security` from there.  
  Mac: Execute `/usr/libexec/java_home` to find Java Home. Switch to that directory and then drill into `jre/lib/security` from there.  
  
4. **NO SPACES** on path for Tomcat!!! (no # either) (Windows limitation)
  - *(El path para la instalacion de tomcat no puede tener espacios ni caracteres especiales. Esto es una limitación de Windows.)*
  
5. Set **Tomcat server Heap memory** up on the Java tab in Windows (Rails 4.1 requirement). 
   - `-XX:MaxPermSize=256M`
   - `-XX:PermSize=256M`
   - `-Xmx1024m` (possibly can be lower, like 512m)
   - `-Dfile.encoding=UTF-8`
     - *(Cambiar el setting de 'Heap Memory' en el tab de Java en la aplicación para el monitoreo de Tomcat (Windows) o en la configuración de Java. La ultima opción es particularmente importante para Rails 4.1 y Ubuntu.)*![Tomcat Windows Java Config](<%= asset_path('tomcat_config_windows.png').url %> "Tomcat Windows Java Config")  
     
  Ubuntu: Tomcat Heap Memory in `/etc/default/tomcat7/` or in `/etc/default/tomcat7/defaults.template`.
     
6. Set up the admin user for Tomcat. In tomcat/conf/tomcat-users.xml set up the following lines: ![Tomcat User Settings](<%= asset_path('tomcatuserssettings.png').url %> "Tomcat User Settings")
   - *(Cree el usuario 'admin' en tomcat-users.xml.)*

7. Increase tomcat7 manager's war deploy size if you want to deploy from the admin gui.
    `tomcat7/webapps/manager/WEB-INF/web.xml`
    
    Ubuntu: `/etc/share/tomcat7-admin/`

8. Run **`jruby -S bundle exec rake db:create db:schema:load RAILS_ENV=production`** (this command can be run from the dev computer if it's in the same network and can connect to the database.) If run on the production machine it must me run on the directory with the application's Rake file:`<tomcat location>/webapps/<app name>/WEB-INF/`. 
  - *(Corra el commando para crear la base de datos. El commando debe correr del archivo localizado en `<tomcat location>/webapps/<app name>/WEB-INF/` que es donde esta localizado el Rakefile.)*
   
Notes/Notas:  
 
## En la maquina de deploy  

1. Utilize Warble 1.4.0.beta1 o mas reciente
2. Cree un web.xml para que se copie -- no lo deje autogenerar.
3. Run JRuby Lint to find issues
4. Flip heroku settins en:
  - Gemfile
  - config/application.rb:  
    ```
    # For Warble
    config.assets.enabled = true
    config.assets.initialize_on_precompile = false
    ```
  - file
  
  
Notes/Notas:

Ubuntu: `sudo service tomcat7 {stop|start|restart}`
Ubuntu: ROOT is in `/var/lib/tomcat7/ROOT`
Ubuntu: Logs are in `/var/log/tomcat7/`


## Usando tomcat en Mac con Homebrew
`hombrew install tomcat`

Verifica con 
`catalina -h` & `catalina run`
To start/stop the server from the command line you use the catalina shell script:
```
$ /usr/local/Cellar/tomcat/7.0.53/bin/catalina run
$ /usr/local/Cellar/tomcat/7.0.53/bin/catalina stop
```

¿Donde esta el directorio webapps? 
`/usr/local/Cellar/tomcat/7.0.53/libexec/webapps/`

# Deploying 

>In order to be able to deploy on both Windows and Linux a Tomcat7 deploy was selected. Heroku was used as a test bed.

Para hacer el deploy que pueda funcionar en Windows y en Linux se selecionó JRuby/Java/Tomcat7 y como prueba Heroku. 

Para hacer el deploy a tomcat primero este tiene que estar ready para un aplicación Rails 4.

Sigua las instruciones en [Instruciones para Tomcat](tomcat_instructions.md "Instruciones para Tomcat") las cuales sirven para Linux o Windows. 

Despues de preparada la maquina para el deploy en la maquina de 'development' corra los comandos para generar el war file.

Translade el war file al file <TOMCAT_HOME>/webapps y corra el tomcat server. 
>Ubuntu: `sudo service tomcat7 {stop|start|restart}`  
>Windows: Apache Tomcat>Monitor Tomcat -- General Tab >> Start

Esto debe crear y poblar un folder en en webapps con el mismo nombre del warfile. 
Esto puede tomar bastante tiempo...

# War file
La generación automatica del warfile es usando el gem Warble version 1.4.0 o mas reciente. Pero esta gema tiene ciertos 'gotchas' entre ellos que los file como web.xml que auto genera pueden contener caracteres chatarra al final, por lo tantos deben ser incluidos manualmente en el projecto para que Warble los cópie en vez de generarlos. 

Warble utiliza el file `config/warble.rb` si existe para su configuración.
Se utilizan las siguientes configuraciones:

```
config.jar_name = "rucpocver#{Time.now.to_i}"
config.excludes = FileList["**/*/*.box"]
config.includes = FileList["Rakefile"]
config.webserver = 'jenkins-ci.winstone'
config.dirs = %w(app config db lib log vendor tmp bin public)
config.bundle_without = []
  #config.features = %w(executable)
```

La primera crea la el nombre del jar con la añadidura del tiempo para evitar conflictos de nombre.  
La segunda remueve cualquier file .box para deploys de torquebox.

Todas las opciones `config.webxml` son removidas para crearlas en el web.xml ya hecho. Pero si fuera a generar el primero (siempre y cuando chequeé que el file este bien) estas son las opciones:
```
config.webxml.rails.env = 'production'
config.webxml.jruby.compat.version = "2.0"
config.webxml.jruby.min.runtimes = 1
config.webxml.jruby.max.runtimes = 1 
```

Tambien se le puede añadir esta linea al `web.xml` para darle un nombre a la aplicación en el dashboard de Tomcat
`<display-name>Registro de Cuentas por Cobrar</display-name>`

- Para crear el war file vaya al directorio del app y corra:  
    `warble`  

- Para ver las opciones de warble use `warble -T`

#### Cambios a config/initializers/production.rb y config/application.rb

-Añadir esto a `config/initializers/production.rb`:
```
  # For Warbler
  config.assets.precompile = config.assets.precompile + %w( *.js *.scss *.coffee *.css )
  config.force_ssl = false # Changed for Warbler to false
```

-Añadir esto a `config/application.rb`:
``` 
   # For Warble
    config.assets.enabled = true
    config.assets.initialize_on_precompile = false
    
    # Encoding for Windows Tomcat
    config.encoding = 'utf-8'
```
-Correr `rake assets:precompile`?


#Trouble shooting

1. Me sale un error de JRuby version...![Error Page for JRuby version](<%= asset_path('NewVersionofJRUBY.png').url %>)
>Este error es probablemente porque un gem llamado jruby-jars que contiene el runtime de jruby esta en la version pasada corra `bundle update jruby-jars` en la maquina de development y corra warble again. 

2. No corre Tomcat7 en Windows pero funciona en Linux
>Asegurese que no haya ningún tipo de espacio (' ') o caracter especial (como #) en el PATH de tomcat. Por ejemplo el sugerido es `C:\ApacheTomcat\` pero este que funciona el Linux no funciona en windows: 'ApacheTomcta#7' o uno con espacios 'Apache Tomcat'. 

3. Apache Tomcat sube pero la aplicación no corre
>Creaste la base de datos? Corre `jruby -S rake db:migrate RAILS_ENV=production` por si acaso.    

4. Algo raro con los war files...
>Warble tiene un bug que genera caracteres chatarra al final de files como: `web.xml` si ese el caso puede eliminar estos caracteres chatarra o mejor y sugerido crear un web.xml file en el directorio en la maquina 'development' para que Warble lo copie y no lo genere. 

# Instalación en Windows (solo para Deploy)

1. [JavaSDK](http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html) Java Development Kit
2. [Java JCE](http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html) Java Cryptographic Extensions
1. [Tomcat7](http://tomcat.apache.org/download-70.cgi) Apache Tomcat 7 Server
2. [JRuby](www.jruby.org) necesario para las migraciones del db.
3. [Mariadb](https://mariadb.org/) mejor que MySQL

Hmmm... Maybe I should create a SaltStack script for this...

# Instalación en Mac/Linux (para Development & Deploy)
### Mac
1. [RVM](www.rvm.io) (opcional puedes usar homebrew tambien pero RVM es mejor.) 
   commando: `\curl -sSL https://get.rvm.io | bash -s stable`

2. [Homebrew](http://brew.sh/) comando: 
  `ruby -e "$(curl -fsSL https://raw.github.com/Homebrew/homebrew/go/install)"`
  
3. [JavaSDK](http://www.oracle.com/technetwork/java/javase/downloads/index.html) (puede ser la 6 o 7)

4. [Java JCE](http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html) Java Cryptographic Extensions
5. Maria DB: `brew install mariadb`
6. Tomcat7: `brew install tomcat`

7. JRuby: `brew install jruby` o mejor `rvm install jruby`


### Ubuntu
(usando `sudo apt-get install`)

1. openjdk-7-jdk
2. tomcat7
3. postgresql (o otra base de datos mariadb envuelve añadir un ppa)
4. RVM (ruby version manager) (vea como instalar en la sección de Mac)
5. Configurar el shell en Ubuntu a login shell para RVM (vea site RVM)
6. Jruby: `rvm install jruby`
7. Bajar JCE [Java JCE](http://www.oracle.com/technetwork/java/javase/downloads/jce-7-download-432124.html)
